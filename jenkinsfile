pipeline {
  agent {
    docker {
      image 'maven:3.9.11-eclipse-temurin-21'
      args '''
        --network task-manager-backend_app-net \
        -v maven-cache:/root/.m2 \
        -e MAVEN_OPTS="-Xmx1024m"
      '''
    }
  }

  environment {
    SONAR_HOST_URL = 'http://sonarqube:9000'
    SONAR_TOKEN = credentials('sonar-token-id')
  }

  stages {
    stage('Build & SonarQube') {
      steps {
        dir('backend') {
          sh '''
            mvn clean verify sonar:sonar \
              -Dsonar.host.url=${SONAR_HOST_URL} \
              -Dsonar.token=${SONAR_TOKEN} \
              -Dsonar.projectKey=Task-Manager-Backend
          '''
        }
      }
    }
  }
}